package uk.gov.hmcts.reform.em.npa.service.impl;

import org.apache.pdfbox.pdmodel.PDDocument;
import org.apache.pdfbox.pdmodel.common.PDRectangle;
import org.apache.pdfbox.pdmodel.interactive.annotation.PDAnnotation;
import org.apache.pdfbox.pdmodel.interactive.annotation.PDAnnotationPopup;
import org.apache.pdfbox.pdmodel.interactive.annotation.PDAnnotationTextMarkup;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import uk.gov.hmcts.reform.em.npa.Application;
import uk.gov.hmcts.reform.em.npa.batch.DocumentTaskItemProcessor;
import uk.gov.hmcts.reform.em.npa.service.AnnotationSetDTOToPDAnnotationMapper;
import uk.gov.hmcts.reform.em.npa.service.dto.external.annotation.AnnotationDTO;
import uk.gov.hmcts.reform.em.npa.service.dto.external.annotation.CommentDTO;
import uk.gov.hmcts.reform.em.npa.service.dto.external.annotation.RectangleDTO;

import java.io.File;
import java.io.IOException;
import java.util.*;
import java.util.stream.Collectors;

@Service
@Transactional
public class AnnotationSetDTOToPDAnnotationMapperImpl implements AnnotationSetDTOToPDAnnotationMapper {

    private final Logger log = LoggerFactory.getLogger(AnnotationSetDTOToPDAnnotationMapperImpl.class);

    private static final String annotationTemplateB64 = "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MDAzMzEwIDAwMDAwIG4gCjAwMDAwMDM4OTEgMDAwMDAgbiAKMDAwMDAwMzUzOCAwMDAwMCBuIAowMDAwMDAzODcxIDAwMDAwIG4gCjAwMDAwMDQxMjcgMDAwMDAgbiAKMDAwMDAxMTk3OSAwMDAwMCBuIAowMDAwMDEyMDAwIDAwMDAwIG4gCjAwMDAwMTIwNDUgMDAwMDAgbiAKMDAwMDAxMjA5OCAwMDAwMCBuIAowMDAwMDEyMTIxIDAwMDAwIG4gCjAwMDAwMTIxNjMgMDAwMDAgbiAKMDAwMDAxMjE4MiAwMDAwMCBuIAp0cmFpbGVyCjw8IC9TaXplIDI0IC9Sb290IDEyIDAgUiAvSW5mbyAxIDAgUiAvSUQgWyA8ZTgyNjAzMWNmYmZmMDM2NTFhNGVmNTRlZDVhNDczMDQ+CjxlODI2MDMxY2ZiZmYwMzY1MWE0ZWY1NGVkNWE0NzMwND4gXSA+PgpzdGFydHhyZWYKMTIzNDYKJSVFT0YKMSAwIG9iag08PC9BQVBMOktleXdvcmRzIDIzIDAgUi9DcmVhdGlvbkRhdGUoRDoyMDE4MDkyNTEyMDIxMlopL0NyZWF0b3IoV29yZCkvS2V5d29yZHMoKS9Nb2REYXRlKEQ6MjAxODA5MjUxMzAzMDIrMDEnMDAnKS9Qcm9kdWNlcihNYWMgT1MgWCAxMC4xMy42IFF1YXJ0eiBQREZDb250ZXh0KS9UaXRsZShNaWNyb3NvZnQgV29yZCAtIERvY3VtZW50MSk+Pg1lbmRvYmoNMiAwIG9iag08PC9Bbm5vdHMgMjUgMCBSL0NvbnRlbnRzIDQgMCBSL01lZGlhQm94WzAgMCA1OTUuMiA4NDEuOF0vUGFyZW50IDMgMCBSL1Jlc291cmNlcyA2IDAgUi9UeXBlL1BhZ2U+Pg1lbmRvYmoNMTIgMCBvYmoNPDwvTWV0YWRhdGEgMjQgMCBSL1BhZ2VzIDMgMCBSL1R5cGUvQ2F0YWxvZz4+DWVuZG9iag0yNCAwIG9iag08PC9MZW5ndGggMzM0OS9TdWJ0eXBlL1hNTC9UeXBlL01ldGFkYXRhPj5zdHJlYW0NCjw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+Cjx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMDE1IDg0LjE1OTgxMCwgMjAxNi8wOS8xMC0wMjo0MTozMCAgICAgICAgIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIgogICAgICAgICAgICB4bWxuczpwZGY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vcGRmLzEuMy8iCiAgICAgICAgICAgIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIKICAgICAgICAgICAgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iPgogICAgICAgICA8eG1wOkNyZWF0ZURhdGU+MjAxOC0wOS0yNVQxMjowMjoxMlo8L3htcDpDcmVhdGVEYXRlPgogICAgICAgICA8eG1wOkNyZWF0b3JUb29sPldvcmQ8L3htcDpDcmVhdG9yVG9vbD4KICAgICAgICAgPHhtcDpNb2RpZnlEYXRlPjIwMTgtMDktMjVUMTM6MDM6MDIrMDE6MDA8L3htcDpNb2RpZnlEYXRlPgogICAgICAgICA8eG1wOk1ldGFkYXRhRGF0ZT4yMDE4LTA5LTI1VDEzOjAzOjAyKzAxOjAwPC94bXA6TWV0YWRhdGFEYXRlPgogICAgICAgICA8cGRmOktleXdvcmRzLz4KICAgICAgICAgPHBkZjpQcm9kdWNlcj5NYWMgT1MgWCAxMC4xMy42IFF1YXJ0eiBQREZDb250ZXh0PC9wZGY6UHJvZHVjZXI+CiAgICAgICAgIDxkYzpmb3JtYXQ+YXBwbGljYXRpb24vcGRmPC9kYzpmb3JtYXQ+CiAgICAgICAgIDxkYzp0aXRsZT4KICAgICAgICAgICAgPHJkZjpBbHQ+CiAgICAgICAgICAgICAgIDxyZGY6bGkgeG1sOmxhbmc9IngtZGVmYXVsdCI+TWljcm9zb2Z0IFdvcmQgLSBEb2N1bWVudDE8L3JkZjpsaT4KICAgICAgICAgICAgPC9yZGY6QWx0PgogICAgICAgICA8L2RjOnRpdGxlPgogICAgICAgICA8eG1wTU06RG9jdW1lbnRJRD51dWlkOjM4MGQwOTU4LTU2NGUtNjU0YS05ZGNmLTg2NDQyYjViY2RiODwveG1wTU06RG9jdW1lbnRJRD4KICAgICAgICAgPHhtcE1NOkluc3RhbmNlSUQ+dXVpZDo0Y2MzMTIwNS1hNWU1LWFiNGUtYmVhMi0wYzA5ODI3NDY2MzQ8L3htcE1NOkluc3RhbmNlSUQ+CiAgICAgIDwvcmRmOkRlc2NyaXB0aW9uPgogICA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgCjw/eHBhY2tldCBlbmQ9InciPz4NZW5kc3RyZWFtDWVuZG9iag0yNSAwIG9iag1bMjYgMCBSIDI3IDAgUl0NZW5kb2JqDTI2IDAgb2JqDTw8L0FQPDwvTiAyOCAwIFI+Pi9DWzEuMCAwLjgxOTYxMSAwLjBdL0NvbnRlbnRzKE5vdGUgY29tbWVudCkvQ3JlYXRpb25EYXRlKEQ6MjAxODA5MjUxMzAyNDErMDEnMDAnKS9GIDQvSVQvSGlnaGxpZ2h0Tm90ZS9NKEQ6MjAxODA5MjUxMzAyNTArMDEnMDAnKS9OTSgzOWNiZGY0MS01ODNhLWY1NDYtOTQxMi0zZTJkZDNhM2RiODEpL1AgMiAwIFIvUG9wdXAgMjcgMCBSL1F1YWRQb2ludHNbNzEuODc5OSA3NzAuNzEyIDkyLjkxNDggNzcwLjcxMiA3MS44Nzk5IDc1NC42NDQgOTIuOTE0OCA3NTQuNjQ0XS9SQyg8P3htbCB2ZXJzaW9uPSIxLjAiPz48Ym9keSB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgeG1sbnM6eGZhPSJodHRwOi8vd3d3LnhmYS5vcmcvc2NoZW1hL3hmYS1kYXRhLzEuMC8iIHhmYTpBUElWZXJzaW9uPSJBY3JvYmF0OjE4LjExLjAiIHhmYTpzcGVjPSIyLjAuMiIgPjxwIGRpcj0ibHRyIj48c3BhbiBkaXI9Imx0ciIgc3R5bGU9ImZvbnQtc2l6ZToxMy4ycHQ7dGV4dC1hbGlnbjpsZWZ0O2NvbG9yOiMwMDAwMDA7Zm9udC1cDXdlaWdodDpub3JtYWw7Zm9udC1zdHlsZTpub3JtYWwiPk5vdGUgY29tbWVudDwvc3Bhbj48L3A+PC9ib2R5PikvUmVjdFs2Ny41OTA2IDc1NC4xNDIgOTcuMjA0MSA3NzEuMjE0XS9TdWJqKENvbW1lbnQgb24gVGV4dCkvU3VidHlwZS9IaWdobGlnaHQvVChwYXdlbCkvVHlwZS9Bbm5vdD4+DWVuZG9iag0yNyAwIG9iag08PC9GIDI4L09wZW4gZmFsc2UvUGFyZW50IDI2IDAgUi9SZWN0WzU5NS4yIDYyOC43MTIgNzc1LjIgNzcwLjcxMl0vU3VidHlwZS9Qb3B1cC9UeXBlL0Fubm90Pj4NZW5kb2JqDTI4IDAgb2JqDTw8L0JCb3hbMC4wIDAuMCAyOS42MTM2IDE3LjA3MTldL0Zvcm1UeXBlIDEvTGVuZ3RoIDIwL01hdHJpeFsxLjAgMC4wIDAuMCAxLjAgMC4wIDAuMF0vUmVzb3VyY2VzPDwvRXh0R1N0YXRlPDwvUjA8PC9BSVMgZmFsc2UvQk0vTXVsdGlwbHkvVHlwZS9FeHRHU3RhdGU+Pj4+L1Byb2NTZXRbL1BERl0vWE9iamVjdDw8L01XRk9Gb3JtIDI5IDAgUj4+Pj4vU3VidHlwZS9Gb3JtL1R5cGUvWE9iamVjdD4+c3RyZWFtDQovUjAgZ3MKL01XRk9Gb3JtIERvCg1lbmRzdHJlYW0NZW5kb2JqDTI5IDAgb2JqDTw8L0JCb3hbMC4wIDAuMCAyOS42MTM2IDE3LjA3MTldL0Zvcm1UeXBlIDEvR3JvdXA8PC9TL1RyYW5zcGFyZW5jeT4+L0xlbmd0aCA5L01hdHJpeFsxLjAgMC4wIDAuMCAxLjAgMC4wIDAuMF0vUmVzb3VyY2VzPDwvUHJvY1NldFsvUERGXS9YT2JqZWN0PDwvRm9ybSAzMCAwIFI+Pj4+L1N1YnR5cGUvRm9ybS9UeXBlL1hPYmplY3Q+PnN0cmVhbQ0KL0Zvcm0gRG8KDWVuZHN0cmVhbQ1lbmRvYmoNMzAgMCBvYmoNPDwvQkJveFs2Ny41OTA2IDc1NC4xNDIgOTcuMjA0MSA3NzEuMjE0XS9Gb3JtVHlwZSAxL0xlbmd0aCAxNjkvTWF0cml4WzEuMCAwLjAgMC4wIDEuMCAtNjcuNTkwNiAtNzU0LjE0Ml0vUmVzb3VyY2VzPDwvUHJvY1NldFsvUERGXT4+L1N1YnR5cGUvRm9ybS9UeXBlL1hPYmplY3Q+PnN0cmVhbQ0KMSAwLjgxOTYxMSAwIHJnCjEuMDA0MiB3CjcxLjg3OTkgNzU0LjY0NDIgbQo2OC4wOTI3IDc1OC40MzE0IDY4LjA5MjcgNzY2LjkyNDcgNzEuODc5OSA3NzAuNzExOSBjCjkyLjkxNDggNzcwLjcxMTkgbAo5Ni43MDIgNzY2LjkyNDcgOTYuNzAyIDc1OC40MzE0IDkyLjkxNDggNzU0LjY0NDIgYwpmCg1lbmRzdHJlYW0NZW5kb2JqDXhyZWYNCjAgMw0KMDAwMDAwMDAwMCA2NTUzNSBmDQowMDAwMDEyOTg0IDAwMDAwIG4NCjAwMDAwMTMxOTQgMDAwMDAgbg0KMTIgMQ0KMDAwMDAxMzMwOCAwMDAwMCBuDQoyNCA3DQowMDAwMDEzMzcwIDAwMDAwIG4NCjAwMDAwMTY3OTYgMDAwMDAgbg0KMDAwMDAxNjgyOCAwMDAwMCBuDQowMDAwMDE3NTU1IDAwMDAwIG4NCjAwMDAwMTc2NjUgMDAwMDAgbg0KMDAwMDAxNzk0NyAwMDAwMCBuDQowMDAwMDE4MTgwIDAwMDAwIG4NCnRyYWlsZXINPDwvU2l6ZSAzMS9Sb290IDEyIDAgUi9JbmZvIDEgMCBSL0lEWzxFODI2MDMxQ0ZCRkYwMzY1MUE0RUY1NEVENUE0NzMwND48MEM5QTBBQkQ5RDJFNEUwRDkwQTNFMjhDQjJFMERFNEQ+XS9QcmV2IDEyMzQ2Pj4Nc3RhcnR4cmVmDTE4NTQ0DSUlRU9GDQ==";

    @Override
    public Map<Integer, List<PDAnnotation>> toNativeAnnotationsPerPage(Set<AnnotationDTO> annotations) throws DocumentTaskProcessingException {


        Map<Integer, List<PDAnnotation>> result = new HashMap<>();

        annotations.stream().forEach( annotationDTO -> {

            Integer pageNumber = annotationDTO.getPage();

            if (!result.containsKey(pageNumber)) {
                result.put(pageNumber, new LinkedList<>());
            }

            List<PDAnnotation> currentPageList = result.get(pageNumber);

            String allComments = annotationDTO.getComments() != null ?
                    annotationDTO.getComments().stream().sorted(Comparator.comparing(CommentDTO::getCreatedDate)).map(CommentDTO::getContent).collect(Collectors.joining("\n")) : null;

            if (annotationDTO.getRectangles() != null) {

                annotationDTO.getRectangles().forEach(rectangleDTO -> {
                    getAnnotationsTemplate().forEach(a -> {
                        a.setPage(null);
                        PDRectangle position = rectangleDTOToPDRectangle(rectangleDTO);
                        if (a instanceof PDAnnotationTextMarkup) {
                            PDAnnotationTextMarkup newOne = new PDAnnotationTextMarkup(a.getCOSObject());
                            newOne.setContents(allComments);
                            newOne.setRectangle(position);
                            newOne.setQuadPoints(getQuadsWithRectangle(position));
                            currentPageList.add(a);
                        } else if (a instanceof PDAnnotationPopup) {
                            PDAnnotationPopup newOne = new PDAnnotationPopup(a.getCOSObject());
                            newOne.setContents(allComments);
                            newOne.setRectangle(position);
                            currentPageList.add(a);
                        }
                    });

                });
            }

        });

        return result;
    }

    private List<PDAnnotation> getAnnotationsTemplate()  {

        try {
//            ClassLoader classLoader = Application.class.getClassLoader();
//            File file = new File(classLoader.getResource("annotationTemplate.pdf").getFile());
            PDDocument templateDocument = PDDocument.load(Base64.getDecoder().decode(annotationTemplateB64));
            return templateDocument.getPage(0).getAnnotations();
        } catch (IOException e) {
            System.out.print(e.getMessage()); e.printStackTrace();
            log.error("Could not retrieve the template", e);
            return Collections.EMPTY_LIST;
        }

    }

    private PDRectangle rectangleDTOToPDRectangle(RectangleDTO rectangleDTO) {
        PDRectangle pdRectangle = new PDRectangle();
        pdRectangle.setLowerLeftX(rectangleDTO.getX());
        pdRectangle.setLowerLeftY(rectangleDTO.getY());
        pdRectangle.setUpperRightX(rectangleDTO.getX() + rectangleDTO.getWidth());
        pdRectangle.setUpperRightY(rectangleDTO.getY() + rectangleDTO.getHeight());
        return pdRectangle;
    }

    public static float[] getQuadsWithRectangle(PDRectangle position) {

        // work out the points forming the four corners of the annotations
        // set out in anti clockwise form (Completely wraps the text)
        // OK, the below doesn't match that description.
        // It's what acrobat 7 does and displays properly!
        float[] quads = new float[8];

        quads[0] = position.getLowerLeftX();  // x1
        quads[1] = position.getUpperRightY() - 2; // y1
        quads[2] = position.getUpperRightX(); // x2
        quads[3] = quads[1]; // y2
        quads[4] = quads[0];  // x3
        quads[5] = position.getLowerLeftY() - 2; // y3
        quads[6] = quads[2]; // x4
        quads[7] = quads[5]; // y5

        return quads;
    }


}
